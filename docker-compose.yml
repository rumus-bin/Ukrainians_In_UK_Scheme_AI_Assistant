version: '3.8'

services:
  # Ollama LLM Service (OPTIONAL - comment out if using local Ollama)
  # If you already have Ollama running locally on port 11434, keep this commented out
  # and use OLLAMA_BASE_URL=http://host.docker.internal:11434 in .env
  # ollama:
  #   image: ollama/ollama:latest
  #   container_name: ukraine-bot-ollama
  #   ports:
  #     - "11434:11434"
  #   volumes:
  #     - ollama_models:/root/.ollama
  #   environment:
  #     - OLLAMA_HOST=0.0.0.0
  #   restart: unless-stopped
  #   networks:
  #     - bot-network
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost:11434/api/tags"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  #     start_period: 40s

  # Qdrant Vector Database (primary choice)
  qdrant:
    image: qdrant/qdrant:latest
    container_name: ukraine-bot-qdrant
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant_data:/qdrant/storage
    environment:
      - QDRANT__SERVICE__HTTP_PORT=6333
      - QDRANT__SERVICE__GRPC_PORT=6334
    restart: unless-stopped
    networks:
      - bot-network
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:6333/ || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s

  # ChromaDB Vector Database (alternative option)
  # Uncomment if you prefer ChromaDB over Qdrant
  # chroma:
  #   image: chromadb/chroma:latest
  #   container_name: ukraine-bot-chroma
  #   ports:
  #     - "8000:8000"
  #   volumes:
  #     - chroma_data:/chroma/chroma
  #   environment:
  #     - IS_PERSISTENT=TRUE
  #     - ANONYMIZED_TELEMETRY=FALSE
  #   restart: unless-stopped
  #   networks:
  #     - bot-network

  # Telegram Bot Application
  bot:
    build:
      context: .
      dockerfile: docker/Dockerfile.bot
    container_name: ukraine-bot-app
    depends_on:
      - qdrant
      # Uncomment if using containerized Ollama:
      # - ollama
    volumes:
      - ./src:/app/src
      - ./tests:/app/tests
      - ./mcp-servers:/app/mcp-servers
      - ./data:/app/data
      - ./logs:/app/logs
      - ./.env:/app/.env
      - ./run_ingestion.py:/app/run_ingestion.py
      - ./demo_rag_query.py:/app/demo_rag_query.py
      - ./test_rag_pipeline.py:/app/test_rag_pipeline.py
      - ./test_embedding_model.py:/app/test_embedding_model.py
      - ./test_similarity_scores.py:/app/test_similarity_scores.py
      - ./test_qdrant_search.py:/app/test_qdrant_search.py
    env_file:
      - .env
    environment:
      - PYTHONUNBUFFERED=1
      # OLLAMA_BASE_URL is read from .env file
      # Use host.docker.internal:11434 for local Ollama
      # Use ollama:11434 for containerized Ollama
    restart: unless-stopped
    networks:
      - bot-network
    # Allow container to access host network for local Ollama
    extra_hosts:
      - "host.docker.internal:host-gateway"
    command: python -m src.bot.main

  # Web Scraper Service (runs on schedule)
  scraper:
    build:
      context: .
      dockerfile: docker/Dockerfile.scraper
    container_name: ukraine-bot-scraper
    depends_on:
      - qdrant
      # Uncomment if using containerized Ollama:
      # - ollama
    volumes:
      - ./src:/app/src
      - ./data:/app/data
      - ./logs:/app/logs
      - ./.env:/app/.env
    env_file:
      - .env
    environment:
      - PYTHONUNBUFFERED=1
      # OLLAMA_BASE_URL is read from .env file
    restart: unless-stopped
    networks:
      - bot-network
    # Allow container to access host network for local Ollama
    extra_hosts:
      - "host.docker.internal:host-gateway"
    # Run weekly scraping via cron inside container
    command: sh -c "python -m src.scrapers.scheduler"

  # MCP Web Scraper Service (provides real-time web access to agents)
  mcp-scraper:
    build:
      context: .
      dockerfile: docker/Dockerfile.mcp-scraper
    container_name: ukraine-bot-mcp-scraper
    volumes:
      - ./mcp-servers/web-scraper:/app/mcp-servers/web-scraper
      - mcp_cache:/app/mcp-servers/web-scraper/cache
      - ./logs:/app/logs
    environment:
      - PYTHONUNBUFFERED=1
    restart: unless-stopped
    networks:
      - bot-network
    # MCP server runs on stdio, no exposed ports needed
    # Agents will connect via MCP client

  # Train Monitor Service - Daily Scheduler (monitors UK train stations)
  # Checks train schedules 3 times daily (7:00, 9:00, 12:00) and sends Ukrainian notifications
  train-monitor:
    build:
      context: .
      dockerfile: docker/Dockerfile.bot
    container_name: ukraine-bot-train-monitor
    volumes:
      - ./src:/app/src
      - ./tests:/app/tests
      - ./data:/app/data
      - ./logs:/app/logs
      - ./.env:/app/.env
    env_file:
      - .env
    environment:
      - PYTHONUNBUFFERED=1
      - TZ=Europe/London  # UK timezone for 7:00 AM check
    restart: unless-stopped
    networks:
      - bot-network
    healthcheck:
      test: ["CMD-SHELL", "ps aux | grep '[p]ython -m src.train_monitor.daily_monitor' || exit 1"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 60s
    # Start daily monitor (scheduled checks at 7:00, 9:00, and 12:00)
    command: python -m src.train_monitor.daily_monitor --time 07:00,09:00,12:00

networks:
  bot-network:
    driver: bridge

volumes:
  ollama_models:
    driver: local
  qdrant_data:
    driver: local
  chroma_data:
    driver: local
  mcp_cache:
    driver: local